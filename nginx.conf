# one worker process is fine for local dev
worker_processes  1;

events {                    # basic event-loop settings
    worker_connections 1024;    # max concurrent connections per worker
}

http {
    # ────────── upstream = the three CouchDB back-ends ──────────
    upstream couchdb_cluster {
        ip_hash;                                  # “sticky by client IP”
        server couch1.local:5984  max_fails=3  fail_timeout=15s;  # node-1
        server couch2.local:5984  max_fails=3  fail_timeout=15s;  # node-2
        server couch3.local:5984  max_fails=3  fail_timeout=15s;  # node-3
        #   max_fails / fail_timeout → mark node DOWN after 3 failed tries
    }

    # ────────── single virtual host on port 5984 ──────────
    server {
        listen 5984;           # expose http://localhost:5984

        # proxy *everything* to the upstream cluster
        location / {
            proxy_pass http://couchdb_cluster;

            # forward original request metadata (useful for logs / auth)
            proxy_set_header Host              $host;            # preserve Host header
            proxy_set_header X-Real-IP         $remote_addr;     # client IP
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;          # http
        }
    }
}